<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Link & QR Code Generator</title>

    <!-- QR-style favicon (no file upload needed) -->
    <link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23004665'/%3E%3Crect x='15' y='15' width='25' height='25' fill='white'/%3E%3Crect x='60' y='15' width='25' height='25' fill='white'/%3E%3Crect x='15' y='60' width='25' height='25' fill='white'/%3E%3Crect x='60' y='60' width='25' height='25' fill='white'/%3E%3C/svg%3E">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background:#ffffff;
            padding:20px;
        }

        .container {
            max-width:900px;
            margin:0 auto;
            background:#fff;
            border-radius:20px;
            border:1px solid #ddd;
            box-shadow:0 10px 40px rgba(0,0,0,0.1);
            overflow:hidden;
        }

        .header {
            background:#004665;
            color:#fff;
            padding:30px;
            text-align:center;
        }

        .header h1 {
            font-size:28px;
            margin-bottom:10px;
        }

        .header p {
            font-size:14px;
            opacity:0.95;
        }

        .content { padding:30px; }

        .form-group { margin-bottom:20px; }

        .form-row {
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:20px;
            margin-bottom:20px;
        }

        label {
            display:block;
            font-weight:600;
            margin-bottom:6px;
            color:#333;
        }

        .required { color:#e74c3c; }

        .label-desc {
            font-weight:400;
            color:#555;
        }

        input[type="text"] {
            width:100%;
            padding:12px 14px;
            border-radius:8px;
            border:2px solid #ccc;
            font-size:14px;
            transition:border-color 0.2s;
        }

        input[type="text"]:focus {
            outline:none;
            border-color:#004665;
        }

        .hint {
            font-size:13px;
            color:#333;
            margin-top:8px;
            line-height:1.5;
            font-weight:400;
        }

        .examples {
            font-size:12px;
            color:#555;
            margin-top:8px;
            font-family:'Courier New', monospace;
            background:#f0f0f0;
            padding:8px 12px;
            border-radius:5px;
            line-height:1.6;
            border:1px solid #e0e0e0;
        }

        .examples code {
            background:transparent;
            padding:0;
        }

        /* Optional section */
        .optional-section {
            margin-top:10px;
            padding:15px;
            border-radius:10px;
            border:2px dashed #ccc;
            background:#fafafa;
        }

        .optional-toggle {
            display:flex;
            align-items:center;
            gap:8px;
            cursor:pointer;
            user-select:none;
        }

        .optional-toggle input {
            width:18px;
            height:18px;
        }

        .optional-toggle label {
            margin:0;
            font-weight:700;
            color:#004665;
            cursor:pointer;
        }

        .optional-fields {
            display:none;
            margin-top:15px;
        }

        .optional-fields.show {
            display:block;
        }

        .button-group {
            display:flex;
            gap:15px;
            margin-top:20px;
        }

        button {
            flex:1;
            padding:15px;
            font-size:16px;
            font-weight:600;
            border:none;
            border-radius:8px;
            cursor:pointer;
            transition:all 0.2s;
        }

        .btn-generate {
            background:#004665;
            color:#fff;
        }

        .btn-generate:hover:not(:disabled) {
            box-shadow:0 4px 12px rgba(0,70,101,0.4);
            transform:translateY(-1px);
        }

        .btn-generate.disabled,
        .btn-generate:disabled {
            opacity:0.5;
            cursor:not-allowed;
            box-shadow:none;
            transform:none;
        }

        .btn-reset {
            background:#e0e0e0;
            color:#333;
        }

        .btn-reset:hover {
            background:#d2d2d2;
        }

        .result-section {
            margin-top:25px;
        }

        .result-section h3 {
            color:#004665;
            font-size:18px;
            margin-bottom:8px;
        }

        .url-display {
            position:relative;
            background:#f8f8f8;
            border-radius:8px;
            border:2px solid #ccc;
            padding:0;
        }

        .url-display input {
            width:100%;
            border:none;
            outline:none;
            background:transparent;
            padding:10px 80px 10px 12px;
            font-family:'Courier New', monospace;
            font-size:13px;
            border-radius:8px;
        }

        .copy-btn {
            position:absolute;
            top:50%;
            right:8px;
            transform:translateY(-50%);
            padding:6px 14px;
            background:#004665;
            color:#fff;
            border:none;
            border-radius:5px;
            font-size:12px;
            cursor:pointer;
        }

        .copy-btn:hover {
            background:#00324a;
        }

        #qrSection {
            display:none;
            margin-top:25px;
        }

        .qr-container {
            background:#f8f8f8;
            border-radius:10px;
            padding:20px;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
        }

        #qrcode {
            margin:0 0 15px 0;
        }

        .download-btn {
            margin-top:5px;
            padding:10px 24px;
            border-radius:8px;
            border:none;
            background:#004665 !important;
            color:#fff;
            font-weight:600;
            cursor:pointer;
        }

        .download-btn:hover {
            background:#00324a !important;
        }

        .video-wrapper {
            max-width:900px;
            margin:40px auto 0;
            text-align:center;
        }

        .video-wrapper iframe {
            width:100%;
            max-width:560px;
            height:315px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.25);
        }

        @media (max-width:768px){
            .form-row { grid-template-columns:1fr; }
            .button-group { flex-direction:column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó UTM Link & QR Code Generator</h1>
            <p>Liberty Building Supply - Campaign Tracking Tool</p>
        </div>

        <div class="content">
            <!-- FORM -->
            <form id="utmForm" oninput="handleFormInput()">
                <div class="form-row">
                    <div class="form-group">
                        <label>Website URL <span class="required">*</span></label>
                        <input type="text" id="websiteUrl" value="libertybuildingsupply.net">
                        <div class="hint">https:// will be added automatically</div>
                    </div>

                    <div class="form-group">
                        <label>Landing Page</label>
                        <input type="text" id="landingPage" placeholder="">
                        <div class="hint">Leave empty to use homepage</div>
                    </div>
                </div>

                <!-- Campaign Source -->
                <div class="form-group">
                    <label>
                        Campaign Source <span class="required">*</span>
                        <span class="label-desc">(The specific place or object where this link appears)</span>
                    </label>
                    <input type="text" id="campaignSource" placeholder="">
                    <div class="examples">Examples: <code>casey-shopper</code>, <code>lbs-product-catalog</code>, <code>pcbe</code>, <code>newsletter</code>, <code>jobsite-sign</code></div>
                </div>

                <!-- Campaign Medium -->
                <div class="form-group">
                    <label>
                        Campaign Medium <span class="required">*</span>
                        <span class="label-desc">(The type of marketing channel used to share the link)</span>
                    </label>
                    <input type="text" id="campaignMedium" placeholder="">
                    <div class="examples">Examples: <code>print</code>, <code>social</code>, <code>email</code>, <code>search</code>, <code>googleads</code>, <code>website</code>, <code>blog</code></div>
                </div>

                <!-- Campaign Name -->
                <div class="form-group">
                    <label>
                        Campaign Name <span class="required">*</span>
                        <span class="label-desc">(The name of the promotion, catalog edition, campaign, season, etc)</span>
                    </label>
                    <input type="text" id="campaignName" placeholder="">
                    <div class="examples">Examples: <code>catalog-ed1</code>, <code>monthly-march-2025</code>, <code>lumbersale-q2</code>, <code>open-house-april</code></div>
                </div>

                <!-- OPTIONAL FIELDS -->
                <div class="optional-section">
                    <div class="optional-toggle" onclick="toggleOptional()">
                        <input type="checkbox" id="showOptional">
                        <label for="showOptional">Show Optional Fields</label>
                    </div>

                    <div id="optionalFields" class="optional-fields">
                        <div class="form-group">
                            <label>Campaign ID</label>
                            <input type="text" id="campaignId">
                        </div>

                        <div class="form-group">
                            <label>Campaign Term</label>
                            <input type="text" id="campaignTerm">
                        </div>

                        <div class="form-group">
                            <label>Campaign Content</label>
                            <input type="text" id="campaignContent">
                        </div>
                    </div>
                </div>
            </form>

            <!-- URL PREVIEW -->
            <div class="result-section">
                <h3>üîé Your Campaign URL</h3>
                <div class="url-display">
                    <input type="text" id="generatedUrl" readonly>
                    <button class="copy-btn" onclick="copyUrl(event)">Copy</button>
                </div>
            </div>

            <!-- BUTTONS -->
            <div class="button-group">
                <button id="btnGenerate" type="button"
                        class="btn-generate disabled"
                        disabled
                        onclick="generateQR()">
                    üöÄ Generate QR Code
                </button>
                <button type="button" class="btn-reset" onclick="resetForm()">Reset</button>
            </div>

            <!-- QR SECTION -->
            <div id="qrSection">
                <div class="result-section">
                    <h3>üì± QR Code</h3>
                    <div class="qr-container">
                        <div id="qrcode"></div>
                        <button type="button" class="download-btn" onclick="downloadQR()">‚¨áÔ∏è Download QR Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIDEO -->
    <div class="video-wrapper">
        <iframe src="https://www.youtube.com/embed/MEUKGcVOJl4" allowfullscreen></iframe>
    </div>

    <script>
        // Sanitize input to lowercase with hyphens only
        function sanitizeInput(value) {
            return value
                .toLowerCase()
                .replace(/[^a-z0-9-]/g, '-')  // Replace any non-alphanumeric (except hyphen) with hyphen
                .replace(/-+/g, '-')          // Replace multiple hyphens with single hyphen
                .replace(/^-|-$/g, '');       // Remove leading/trailing hyphens
        }

        // Helper to safely bind sanitizer to a field if it exists
        function bindSanitizer(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const oldLength = e.target.value.length;
                e.target.value = sanitizeInput(e.target.value);
                const newLength = e.target.value.length;
                const delta = oldLength - newLength;
                const newPos = Math.max(0, cursorPos - delta);
                e.target.setSelectionRange(newPos, newPos);
            });
        }

        // Apply sanitization to UTM fields on input
        bindSanitizer('campaignSource');
        bindSanitizer('campaignMedium');
        bindSanitizer('campaignName');
        bindSanitizer('campaignId');
        bindSanitizer('campaignTerm');
        bindSanitizer('campaignContent');

        // Sanitize landing page path
        document.getElementById('landingPage').addEventListener('input', function(e) {
            let value = e.target.value.toLowerCase();
            // Remove protocol if user pastes it
            value = value.replace(/^https?:\/\//i, '');
            // Remove domain if user pastes full URL
            value = value.replace(/^[^\/]*libertybuildingsupply\.net\/?/i, '');
            e.target.value = value;
        });

        function toggleOptional() {
            const checkbox = document.getElementById("showOptional");
            const fields   = document.getElementById("optionalFields");
            checkbox.checked = !checkbox.checked;
            fields.classList.toggle("show");
            handleFormInput();
        }

        function buildFinalUrl() {
            let site = document.getElementById("websiteUrl").value.trim();
            if (!site) return "";

            if (!site.startsWith("http://") && !site.startsWith("https://")) {
                site = "https://" + site;
            }

            let url;
            try {
                url = new URL(site);
            } catch {
                return "";
            }

            // Add landing page path if provided (optional)
            const landingPage = document.getElementById("landingPage").value.trim();
            if (landingPage) {
                const path = landingPage.startsWith('/') ? landingPage : '/' + landingPage;
                url.pathname = path;
            }

            const params = {
                utm_source:   document.getElementById("campaignSource").value.trim(),
                utm_medium:   document.getElementById("campaignMedium").value.trim(),
                utm_campaign: document.getElementById("campaignName").value.trim(),
                utm_id:       document.getElementById("campaignId").value.trim(),
                utm_term:     document.getElementById("campaignTerm").value.trim(),
                utm_content:  document.getElementById("campaignContent").value.trim()
            };

            // Clear existing utm params, then add
            Object.keys(params).forEach(k => url.searchParams.delete(k));
            Object.keys(params).forEach(k => {
                if (params[k]) url.searchParams.set(k, params[k]);
            });

            return url.toString();
        }

        function requiredFieldsFilled() {
            const website = document.getElementById("websiteUrl").value.trim();
            const src     = document.getElementById("campaignSource").value.trim();
            const med     = document.getElementById("campaignMedium").value.trim();
            const name    = document.getElementById("campaignName").value.trim();
            // Landing page is optional
            return website && src && med && name;
        }

        function updateGenerateButtonState() {
            const btn = document.getElementById("btnGenerate");
            const url = buildFinalUrl();
            if (requiredFieldsFilled() && url) {
                btn.disabled = false;
                btn.classList.remove("disabled");
            } else {
                btn.disabled = true;
                btn.classList.add("disabled");
            }
        }

        function handleFormInput() {
            const finalUrl = buildFinalUrl();
            document.getElementById("generatedUrl").value = finalUrl;
            updateGenerateButtonState();
        }

        function generateQR() {
            const btn = document.getElementById("btnGenerate");
            if (btn.disabled) return;

            const finalUrl = buildFinalUrl();
            if (!finalUrl) return;

            document.getElementById("generatedUrl").value = finalUrl;

            const qrSection   = document.getElementById("qrSection");
            const qrContainer = document.getElementById("qrcode");

            qrSection.style.display = "block";
            qrContainer.innerHTML   = "";

            new QRCode(qrContainer, {
                text: finalUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function copyUrl(e) {
            e.preventDefault();
            const text = document.getElementById("generatedUrl").value;
            if (!text) return;

            navigator.clipboard.writeText(text).then(() => {
                const btn = e.target;
                const original = btn.textContent;
                btn.textContent = "Copied!";
                setTimeout(() => btn.textContent = original, 1500);
            });
        }

        function downloadQR() {
            const canvas = document.querySelector("#qrcode canvas");
            if (!canvas) return;

            const landing = document.getElementById("landingPage").value.trim().replace(/^\/+|\/+$/g, '').replace(/\//g, '-');
            const src  = document.getElementById("campaignSource").value.trim();
            const med  = document.getElementById("campaignMedium").value.trim();
            const name = document.getElementById("campaignName").value.trim();

            const parts = [landing, src, med, name].filter(Boolean);
            const filename = (parts.join("-") || "qr") + "-qr-code.png";

            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = filename;
            link.click();
        }

        function resetForm() {
            document.getElementById("utmForm").reset();

            // Restore defaults
            document.getElementById("websiteUrl").value = "libertybuildingsupply.net";
            document.getElementById("landingPage").value = "";

            document.getElementById("generatedUrl").value = "";
            document.getElementById("qrSection").style.display = "none";
            document.getElementById("qrcode").innerHTML = "";

            document.getElementById("showOptional").checked = false;
            document.getElementById("optionalFields").classList.remove("show");

            handleFormInput();
        }

        // Initialize on load
        handleFormInput();
    </script>
</body>
</html>
